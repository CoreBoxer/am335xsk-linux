name: 2. Build Linux Kernel (AM335x)

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-kernel.yml'

env:
  CROSS_COMPILE: arm-linux-gnueabihf-
  ARCH: arm
  KERNEL_VER: linux-6.19.y # 可以在这里修改内核版本

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-linux-gnueabihf bc bison flex libssl-dev libncurses-dev

    - name: Download Kernel Source
      run: |
        git clone --depth 1 --branch ${{ env.KERNEL_VER }} https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git linux-src

    - name: Configure Kernel
      working-directory: linux-src
      run: |
        make multi_v7_defconfig
        
        # =======================================================
        # 关键修改：将显示相关的驱动从 Module(m) 改为 Built-in(y)
        # =======================================================
        
        # 1. 启用脚本修改工具
        chmod +x scripts/config
        
        # 2. 强制开启 PWM 子系统 (背光需要)
        ./scripts/config --enable CONFIG_PWM
        ./scripts/config --enable CONFIG_PWM_TIECAP    # AM335x 的 ECAP PWM
        ./scripts/config --enable CONFIG_PWM_TIEHRPWM  # AM335x 的 EHRPWM
        ./scripts/config --enable CONFIG_PWM_OMAP_DMTIMER
        
        # 3. 强制开启 DRM 显示子系统 (LCD需要)
        ./scripts/config --enable CONFIG_DRM
        ./scripts/config --enable CONFIG_DRM_TILCDC    # AM335x 的 LCD 控制器
        ./scripts/config --enable CONFIG_DRM_TI_TFP410 # 可能需要的编码器
        ./scripts/config --enable CONFIG_BACKLIGHT_PWM # PWM 背光驱动
        
        # 4. 强制开启触摸屏驱动 (既然有屏幕，触摸也顺便开了)
        ./scripts/config --enable CONFIG_INPUT_TOUCHSCREEN
        ./scripts/config --enable CONFIG_TOUCHSCREEN_TI_AM335X_TSC # 电阻屏驱动
        
        # 5. 更新配置依赖
        make olddefconfig

    - name: Build Kernel & DTBs
      working-directory: linux-src
      run: make -j$(nproc) zImage dtbs

    - name: Organize Artifacts
      working-directory: linux-src
      run: |
        mkdir dist
        cp arch/arm/boot/zImage dist/
        # 精确查找 EVM-SK 的设备树
        find arch/arm/boot/dts -name "am335x-evmsk.dtb" -exec cp {} dist/ \;
        echo "Build Complete. Artifacts prepared."

    - name: Upload Kernel Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-images
        path: linux-src/dist/*